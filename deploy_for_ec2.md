# PM2 + Systemd Deployment Setup Documentation

## Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Component Breakdown](#component-breakdown)
4. [How It Works](#how-it-works)
5. [Setup Instructions](#setup-instructions)
6. [Troubleshooting](#troubleshooting)

---

## Overview

This setup creates an automated deployment system that:
- Runs a custom systemd service on boot
- Pulls latest code from git
- Builds the application
- Manages the Node.js application with PM2
- Persists PM2 processes across reboots

## Architecture

```
Boot Sequence:
┌─────────────────┐
│  System Boot    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ network.target  │  (Network is ready)
└────────┬────────┘
         │
         ▼
┌──────────────────────────┐
│ myown-deploy-pm2.service │  (Deploy script runs)
│  - git pull              │
│  - npm build             │
│  - pm2 reload            │
└────────┬─────────────────┘
         │
         ▼
┌─────────────────┐
│ pm2-ubuntu.service│  (PM2 daemon starts)
│  - Resurrects     │
│    saved apps     │
└───────────────────┘
```

## Component Breakdown

### 1. Systemd Service (`myown-deploy-pm2.service`)

**Location:** `/etc/systemd/system/myown-deploy-pm2.service`

**Purpose:** Runs deployment tasks on boot before PM2 starts

```ini
[Unit]
Description=Service to redeploy project and launch pm2
After=network.target

[Service]
Type=oneshot
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/
Environment="PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"
ExecStart=/bin/bash /home/ubuntu/deploy.sh
RemainAfterExit=no
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**Key Directives Explained:**

- `After=network.target` - Waits for network to be available before starting
- `Type=oneshot` - Service runs once and exits (not a daemon)
- `User=ubuntu` - Runs as ubuntu user (important for file permissions)
- `Environment="PATH=..."` - Sets PATH so script can find node, npm, pm2
- `WorkingDirectory=/home/ubuntu/` - Sets working directory for the script
- `ExecStart=` - Command to execute
- `StandardOutput=journal` - Logs go to systemd journal (viewable with `journalctl`)
- `WantedBy=multi-user.target` - Service runs at normal system startup

### 2. Deployment Script (`deploy.sh`)

**Location:** `/home/ubuntu/deploy.sh`

**Purpose:** Performs deployment tasks (git pull, build, PM2 reload)

```bash
#!/usr/bin/env bash
set -e  # Exit on any error

APP_NAME="polymarket-copytrading"
LOG_DIR="/home/ubuntu/deploy-logs"
WORK_DIR="/home/ubuntu/"

# Set PATH with all required binaries
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"

# Create log directory
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/deploy-prep-$(date +%Y%m%d-%H%M%S).log"

# Redirect all output to log file
exec >> "$LOG_FILE" 2>&1

echo "==============================="
echo "DEPLOY PREP START: $(date)"
echo "==============================="

# Change to working directory
cd "$WORK_DIR" || { echo "Failed to cd to $WORK_DIR"; exit 1; }

# Pull latest code
git pull origin main

# Flush PM2 logs
pm2 flush

# Clean dist folder
[ -d "dist" ] && rm -rf dist/* || echo "Dist folder did not exist"

# Build application
npm run build

# Verify .env exists
[ -f ".env" ] || { echo "Missing .env file"; exit 1; }

# Verify dist folder was created
[ -d "dist" ] || { echo "Missing dist folder"; exit 1; }

echo "==============================="
echo "DEPLOY PREP END: $(date) | STATUS: SUCCESS"
echo "==============================="

# Reload PM2 apps (or start if not running)
pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js

# Keep only last 5 log files
ls -1t "$LOG_DIR"/deploy-prep-*.log | tail -n +6 | xargs -r rm -f
```

**Key Concepts:**

- `set -e` - Script exits immediately if any command fails
- `exec >> "$LOG_FILE" 2>&1` - Redirects all stdout and stderr to log file
- `||` - Logical OR, runs second command if first fails
- `[ -d "dir" ]` - Tests if directory exists
- `pm2 reload` - Gracefully reloads app (0-downtime), falls back to `start` if not running

### 3. PM2 System Service (`pm2-ubuntu.service`)

**Location:** `/etc/systemd/system/pm2-ubuntu.service`

**Purpose:** Manages PM2 daemon as a system service

**Generated by:** `pm2 startup systemd -u ubuntu --hp /home/ubuntu`

```ini
[Unit]
Description=PM2 process manager
Documentation=https://pm2.keymetrics.io/
After=network.target myown-deploy-pm2.service

[Service]
Type=forking
User=ubuntu
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Environment=PATH=/usr/local/bin:/usr/bin:/bin
Environment=PM2_HOME=/home/ubuntu/.pm2
PIDFile=/home/ubuntu/.pm2/pm2.pid
Restart=on-failure
ExecStart=/usr/local/lib/node_modules/pm2/bin/pm2 resurrect
ExecReload=/usr/local/lib/node_modules/pm2/bin/pm2 reload all
ExecStop=/usr/local/lib/node_modules/pm2/bin/pm2 kill

[Install]
WantedBy=multi-user.target
```

**Key Directives:**

- `After=myown-deploy-pm2.service` - Waits for deploy service to complete first
- `Type=forking` - PM2 daemon forks into background
- `ExecStart=... resurrect` - Restores saved PM2 process list
- `Restart=on-failure` - Automatically restarts if PM2 crashes

## How It Works

### Boot Sequence

1. **System Boots**
   - Kernel loads
   - Systemd initializes

2. **Network Target Reached**
   - Network interfaces are up
   - `network.target` is active

3. **Deploy Service Runs** (`myown-deploy-pm2.service`)
   - Executes `/home/ubuntu/deploy.sh`
   - Pulls latest code from git
   - Builds application (`npm run build`)
   - Attempts to reload PM2 apps
   - Logs everything to `/home/ubuntu/deploy-logs/`
   - Service exits (Type=oneshot)

4. **PM2 Service Starts** (`pm2-ubuntu.service`)
   - PM2 daemon starts
   - Reads `/home/ubuntu/.pm2/dump.pm2`
   - Resurrects all saved processes
   - Your app is now running

### PM2 Process Resurrection

PM2 saves its process list to `/home/ubuntu/.pm2/dump.pm2` when you run:
```bash
pm2 save
```

This file contains:
- Process names
- Script paths
- Environment variables
- Configuration

On boot, `pm2 resurrect` reads this file and starts all saved processes.

### User Permissions

**Critical:** Everything must run as the same user (`ubuntu`):
- Systemd services: `User=ubuntu`
- PM2 daemon: Started as ubuntu user
- Application files: Owned by ubuntu

**Why?** Different users have different PM2 instances:
- Root's PM2: `/root/.pm2/`
- Ubuntu's PM2: `/home/ubuntu/.pm2/`

They don't share process lists!

## Setup Instructions

### Initial Setup

```bash
# 1. Create deployment script
sudo nano /home/ubuntu/deploy.sh
# (paste script content)
sudo chmod +x /home/ubuntu/deploy.sh
sudo chown ubuntu:ubuntu /home/ubuntu/deploy.sh

# 2. Create log directory
sudo mkdir -p /home/ubuntu/deploy-logs
sudo chown ubuntu:ubuntu /home/ubuntu/deploy-logs
sudo chmod 755 /home/ubuntu/deploy-logs

# 3. Create systemd service
sudo nano /etc/systemd/system/myown-deploy-pm2.service
# (paste service content)

# 4. Set up PM2 as ubuntu user
su - ubuntu
cd /home/ubuntu
pm2 startup systemd -u ubuntu --hp /home/ubuntu
# Copy and run the sudo command it outputs

# 5. Start your app and save
pm2 start ecosystem.config.js
pm2 save

# 6. Edit PM2 service to wait for deploy service
exit  # back to root/sudo user
sudo systemctl edit pm2-ubuntu.service --full
# Add "myown-deploy-pm2.service" to the After= line

# 7. Enable services
sudo systemctl daemon-reload
sudo systemctl enable myown-deploy-pm2.service
sudo systemctl enable pm2-ubuntu.service

# 8. Test
sudo reboot
```

### After Reboot

```bash
# Check deploy service ran
sudo systemctl status myown-deploy-pm2.service
cat /home/ubuntu/deploy-logs/deploy-prep-*.log

# Check PM2 is running
sudo systemctl status pm2-ubuntu.service
pm2 status  # Should show your app
```

## Troubleshooting

### Service Failed to Start

```bash
# Check service status
sudo systemctl status myown-deploy-pm2.service

# View detailed logs
sudo journalctl -u myown-deploy-pm2.service -n 100

# Check deploy script logs
cat /home/ubuntu/deploy-logs/deploy-prep-*.log
```

### PM2 Processes Not Showing

**Problem:** Running `pm2 status` shows nothing after reboot

**Likely Cause:** PM2 running as different user

```bash
# Check which PM2 service is running
sudo systemctl list-units | grep pm2

# If you see pm2-root.service, PM2 is running as root
# Fix: Remove root PM2 and set up ubuntu PM2
sudo systemctl stop pm2-root.service
sudo systemctl disable pm2-root.service
sudo rm /etc/systemd/system/pm2-root.service

# Set up for ubuntu
su - ubuntu
pm2 startup systemd -u ubuntu --hp /home/ubuntu
# Run the sudo command it gives you
```

### Permission Denied Errors

```bash
# Check file ownership
ls -la /home/ubuntu/deploy.sh
ls -la /home/ubuntu/deploy-logs/

# Fix ownership
sudo chown -R ubuntu:ubuntu /home/ubuntu/deploy-logs
sudo chown ubuntu:ubuntu /home/ubuntu/deploy.sh
```

### Git Pull Fails

**Error:** `fatal: not a git repository`

**Fix:** Ensure WorkingDirectory points to git repo

```bash
# Check if /home/ubuntu is a git repo
cd /home/ubuntu
git status

# If not, fix WORK_DIR in deploy.sh to point to actual repo
```

### npm/pm2 Command Not Found

**Error:** `command not found: npm` or `pm2`

**Fix:** Add proper PATH to service file

```bash
# Find where commands are
which node
which npm
which pm2

# Add those paths to Environment= in service file
sudo systemctl edit myown-deploy-pm2.service --full
# Add: Environment="PATH=/usr/local/bin:/usr/bin:/bin:..."
```

### Checking Boot Order

```bash
# See service dependencies
systemctl list-dependencies pm2-ubuntu.service

# See what services started when
systemd-analyze plot > boot.svg
# Open boot.svg in browser to see timeline
```

## Common Commands

```bash
# Systemd service management
sudo systemctl start myown-deploy-pm2.service    # Start service
sudo systemctl stop myown-deploy-pm2.service     # Stop service
sudo systemctl restart myown-deploy-pm2.service  # Restart service
sudo systemctl status myown-deploy-pm2.service   # Check status
sudo systemctl enable myown-deploy-pm2.service   # Enable on boot
sudo systemctl disable myown-deploy-pm2.service  # Disable on boot

# View logs
sudo journalctl -u myown-deploy-pm2.service      # View service logs
sudo journalctl -u myown-deploy-pm2.service -f   # Follow logs live
cat /home/ubuntu/deploy-logs/deploy-prep-*.log   # View deploy logs

# PM2 commands
pm2 status                    # List all processes
pm2 logs                      # View logs
pm2 restart all               # Restart all apps
pm2 reload all                # Zero-downtime reload
pm2 save                      # Save process list
pm2 resurrect                 # Restore saved processes
pm2 startup                   # Generate startup script

# Reload systemd after changes
sudo systemctl daemon-reload
```

## Best Practices

1. **Always use the same user** - Deploy script, PM2, and app files should all be owned by `ubuntu`

2. **Test manually first** - Before enabling services, test your deploy script manually:
   ```bash
   su - ubuntu
   cd /home/ubuntu
   bash deploy.sh
   ```

3. **Check logs** - Always check both systemd logs and your deploy logs:
   ```bash
   sudo journalctl -u myown-deploy-pm2.service -n 50
   tail -f /home/ubuntu/deploy-logs/deploy-prep-*.log
   ```

4. **Use pm2 reload, not restart** - `pm2 reload` provides zero-downtime updates

5. **Save PM2 process list** - After any PM2 changes, run `pm2 save`

6. **Version control your configs** - Keep systemd service files and scripts in git

## Security Considerations

- Services run as `ubuntu` user (not root) - limits damage if compromised
- Use `.env` files for secrets (never commit to git)
- Restrict permissions on sensitive files:
  ```bash
  chmod 600 .env
  chmod 700 deploy.sh
  ```
- PM2 logs may contain sensitive data - restrict access to log directories

## Additional Resources

- [Systemd Documentation](https://www.freedesktop.org/software/systemd/man/)
- [PM2 Documentation](https://pm2.keymetrics.io/docs/)
- [PM2 Startup Script](https://pm2.keymetrics.io/docs/usage/startup/)
- [Systemd Service File Format](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
